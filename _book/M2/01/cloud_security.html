
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>2.4. Azure identity, access, and security Â· HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 4.0.4">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="lab01.html" />
    
    
    <link rel="prev" href="storage_services.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">About</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    AZURE JOURNEY
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Describe cloud concepts</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../M1/01/">
            
                <a href="../../M1/01/">
            
                    
                    1. Cloud Concepts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../../M1/01/cloud_computinf.html">
            
                <a href="../../M1/01/cloud_computinf.html">
            
                    
                    1.1. Cloud computing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../../M1/01/benefits_cloud.html">
            
                <a href="../../M1/01/benefits_cloud.html">
            
                    
                    1.2. Benefits of cloud services
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../../M1/01/cloud_types.html">
            
                <a href="../../M1/01/cloud_types.html">
            
                    
                    1.3. Cloud service types
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Describe Azure architecture and services</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="./">
            
                <a href="./">
            
                    
                    2. Azure architecture and services
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="core_components.html">
            
                <a href="core_components.html">
            
                    
                    2.1. Core Azure architectural components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="networking_services.html">
            
                <a href="networking_services.html">
            
                    
                    2.2. Azure compute and networking services
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="storage_services.html">
            
                <a href="storage_services.html">
            
                    
                    2.3. Azure storage services
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.1.4" data-path="cloud_security.html">
            
                <a href="cloud_security.html">
            
                    
                    2.4. Azure identity, access, and security
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Hands-on Labs</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="lab01.html">
            
                <a href="lab01.html">
            
                    
                    LAB 1 - Create a virtual machine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="lab02.html">
            
                <a href="lab02.html">
            
                    
                    LAB 2 - Create a VM with a Template
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="lab03.html">
            
                <a href="lab03.html">
            
                    
                    LAB 3 - Create a VM with PowerShell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="lab04.html">
            
                <a href="lab04.html">
            
                    
                    LAB 4 - Create a VM with the CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="lab05.html">
            
                <a href="lab05.html">
            
                    
                    LAB 5 - Create a Web App
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="lab06.html">
            
                <a href="lab06.html">
            
                    
                    LAB 6 - Deploy Azure Container Instances
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="lab07.html">
            
                <a href="lab07.html">
            
                    
                    LAB 7 - Implement Azure Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="lab08.html">
            
                <a href="lab08.html">
            
                    
                    LAB 8 - Create a virtual network
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.9" data-path="lab09.html">
            
                <a href="lab09.html">
            
                    
                    LAB 9 - Secure network traffic
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.10" data-path="lab10.html">
            
                <a href="lab10.html">
            
                    
                    LAB 10 - Create Blob storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.11" data-path="lab11.html">
            
                <a href="lab11.html">
            
                    
                    LAB 11 - Create a SQL database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.12" data-path="lab12.html">
            
                <a href="lab12.html">
            
                    
                    LAB 12 - Manage access with RBAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.13" data-path="lab13.html">
            
                <a href="lab13.html">
            
                    
                    LAB 13 - Implement Azure Key Vault
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.14" data-path="lab14.html">
            
                <a href="lab14.html">
            
                    
                    LAB 14 - Implement the Azure IoT Hub
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Describe Azure management and governance</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../M3/01/">
            
                <a href="../../M3/01/">
            
                    
                    3. Azure management and governance
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../M3/01/cost_management.html">
            
                <a href="../../M3/01/cost_management.html">
            
                    
                    3.1. Cost management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../M3/01/gov_compliance.html">
            
                <a href="../../M3/01/gov_compliance.html">
            
                    
                    3.2. Governance and compliance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="../../M3/01/man_deploy_resources.html">
            
                <a href="../../M3/01/man_deploy_resources.html">
            
                    
                    3.3. Managing and deploying resources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.4" data-path="../../M3/01/monitoring_tools.html">
            
                <a href="../../M3/01/monitoring_tools.html">
            
                    
                    3.4. Azure monitoring tools
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Hands-on Labs</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../../M3/01/lab01.html">
            
                <a href="../../M3/01/lab01.html">
            
                    
                    LAB 1 - Use the Azure Pricing Calculator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../../M3/01/lab02.html">
            
                <a href="../../M3/01/lab02.html">
            
                    
                    LAB 2 - Use the Azure TCO Calculator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../../M3/01/lab03.html">
            
                <a href="../../M3/01/lab03.html">
            
                    
                    LAB 3 - Implement resource tagging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="../../M3/01/lab04.html">
            
                <a href="../../M3/01/lab04.html">
            
                    
                    LAB 4 - Manage resource locks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="../../M3/01/lab05.html">
            
                <a href="../../M3/01/lab05.html">
            
                    
                    LAB 5 - Create an Azure Policy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="../../M3/01/lab06.html">
            
                <a href="../../M3/01/lab06.html">
            
                    
                    LAB 6 - Explore the Trust Center
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.7" data-path="../../M3/01/lab07.html">
            
                <a href="../../M3/01/lab07.html">
            
                    
                    LAB 7 - Calculate Composite SLAs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.8" data-path="../../M3/01/lab08.html">
            
                <a href="../../M3/01/lab08.html">
            
                    
                    LAB 8 - Open a Support Request
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >2.4. Azure identity, access, and security</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="work-with-azure-cosmos-db">Work with Azure Cosmos DB</h2>
<p>This module is an introduction to both client and server-side programming on Azure Cosmos DB.</p>
<h2 id="microsoft-net-sdk-v3-for-azure-cosmos-db">Microsoft .NET SDK v3 for Azure Cosmos DB</h2>
<p>This unit focuses on Azure Cosmos DB .NET SDK v3 for API for NoSQL. (<strong>Microsoft.Azure.Cosmos</strong> NuGet package.) If you&apos;re familiar with the previous version of the .NET SDK, you may be used to the terms collection and document.</p>
<p>The <a href="https://github.com/Azure/azure-cosmos-dotnet-v3/tree/master/Microsoft.Azure.Cosmos.Samples/Usage" target="_blank">azure-cosmos-dotnet-v3</a> GitHub repository includes the latest .NET sample solutions. You use these solutions to perform CRUD (create, read, update, and delete) and other common operations on Azure Cosmos DB resources.</p>
<p>Because Azure Cosmos DB supports multiple API models, version 3 of the .NET SDK uses the generic terms &quot;container&quot; and &quot;item&quot;. A <strong>container</strong> can be a collection, graph, or table. An <strong>item</strong> can be a document, edge/vertex, or row, and is the content inside a container.</p>
<p>Below are examples showing some of the key operations you should be familiar with. For more examples please visit the GitHub link above. The examples below all use the async version of the methods.</p>
<h3 id="cosmosclient">CosmosClient</h3>
<p>Creates a new <code>CosmosClient</code> with a connection string. <code>CosmosClient</code> is thread-safe. Its recommended to maintain a single instance of <code>CosmosClient</code> per lifetime of the application which enables efficient connection management and performance.</p>
<pre><code class="lang-azurecli-interactive">CosmosClient client = new CosmosClient(endpoint, key);
</code></pre>
<h2 id="database-examples">Database examples</h2>
<h3 id="create-a-database">Create a database</h3>
<p>The <code>CosmosClient.CreateDatabaseIfNotExistsAsync</code> checks if a database exists, and if it doesn&apos;t, creates it. Only the database <code>id</code> is used to verify if there is an existing database.</p>
<pre><code class="lang-azurecli-interactive">// An object containing relevant information about the response
DatabaseResponse databaseResponse = await client.CreateDatabaseIfNotExistsAsync(databaseId, 10000);
</code></pre>
<h3 id="read-a-database-by-id">Read a database by ID</h3>
<p>Reads a database from the Azure Cosmos DB service as an asynchronous operation.</p>
<pre><code class="lang-azurecli-interactive">DatabaseResponse readResponse = await database.ReadAsync();
</code></pre>
<h3 id="delete-a-database">Delete a database</h3>
<p>Delete a Database as an asynchronous operation.</p>
<pre><code class="lang-azurecli-interactive">await database.DeleteAsync();
</code></pre>
<h2 id="container-examples">Container examples</h2>
<h3 id="create-a-container">Create a container</h3>
<p>The <code>Database.CreateContainerIfNotExistsAsync</code> method checks if a container exists, and if it doesn&apos;t, it creates it. Only the container <code>id</code> is used to verify if there is an existing container.</p>
<pre><code class="lang-azurecli-interactive">// Set throughput to the minimum value of 400 RU/s
ContainerResponse simpleContainer = await database.CreateContainerIfNotExistsAsync(
    id: containerId,
    partitionKeyPath: partitionKey,
    throughput: 400);
</code></pre>
<h3 id="get-a-container-by-id">Get a container by ID</h3>
<pre><code class="lang-azurecli-interactive">Container container = database.GetContainer(containerId);
ContainerProperties containerProperties = await container.ReadContainerAsync();
</code></pre>
<h3 id="delete-a-container">Delete a container</h3>
<p>Delete a Container as an asynchronous operation.</p>
<pre><code class="lang-azurecli-interactive">await database.GetContainer(containerId).DeleteContainerAsync();
</code></pre>
<h2 id="item-examples">Item examples</h2>
<h3 id="create-an-item">Create an item</h3>
<p>Use the <code>Container.CreateItemAsync</code> method to create an item. The method requires a JSON serializable object that must contain an <code>id</code> property, and a <code>partitionKey</code>.</p>
<pre><code class="lang-azurecli-interactive">ItemResponse&lt;SalesOrder&gt; response = await container.CreateItemAsync(salesOrder, new PartitionKey(salesOrder.AccountNumber));
</code></pre>
<h3 id="read-an-item">Read an item</h3>
<p>Use the <code>Container.ReadItemAsync</code> method to read an item. The method requires type to serialize the item to along with an <code>id</code> property, and a <code>partitionKey</code>.</p>
<pre><code class="lang-azurecli-interactive">string id = &quot;[id]&quot;;
string accountNumber = &quot;[partition-key]&quot;;
ItemResponse&lt;SalesOrder&gt; response = await container.ReadItemAsync(id, new PartitionKey(accountNumber));
</code></pre>
<h3 id="query-an-item">Query an item</h3>
<p>The <code>Container.GetItemQueryIterator</code> method creates a query for items under a container in an Azure Cosmos database using a SQL statement with parameterized values. It returns a <code>FeedIterator</code>.</p>
<pre><code class="lang-azurecli-interactive">QueryDefinition query = new QueryDefinition(
    &quot;select * from sales s where s.AccountNumber = @AccountInput &quot;)
    .WithParameter(&quot;@AccountInput&quot;, &quot;Account1&quot;);

FeedIterator&lt;SalesOrder&gt; resultSet = container.GetItemQueryIterator&lt;SalesOrder&gt;(
    query,
    requestOptions: new QueryRequestOptions()
    {
        PartitionKey = new PartitionKey(&quot;Account1&quot;),
        MaxItemCount = 1
    });
</code></pre>
<h2 id="exercise-create-resources-by-using-the-microsoft-net-sdk-v3">Exercise: Create resources by using the Microsoft .NET SDK v3</h2>
<p><img src="images/work_cosmosdb_01.png" alt="alt text"></p>
<p>In this exercise you&apos;ll create a console app to perform the following operations in Azure Cosmos DB:</p>
<ul>
<li>Connect to an Azure Cosmos DB account</li>
<li>Create a database</li>
<li>Create a container</li>
</ul>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li><strong><a href="https://docs.google.com/document/d/1XEkiGWUC4_AzngZQLQnVt8yWCb3dft1HzXglUnJcJzM/edit" target="_blank">Azure Account</a></strong> </li>
<li><strong><a href="https://code.visualstudio.com/" target="_blank">Visual Studio Code</a></strong> on one of the supported platforms.</li>
<li><strong><a href="https://dotnet.microsoft.com/download/dotnet/6.0" target="_blank">.NET 6</a></strong> is the target framework for the steps below.</li>
<li>The <a href="https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csharp" target="_blank">C# extension</a>** for Visual Studio Code.</li>
</ul>
<h3 id="connecting-to-azure">Connecting to Azure</h3>
<ol>
<li><p>Start Visual Studio Code and open a terminal window by selecting <strong>Terminal</strong> from the top application bar, then choosing <strong>New Terminal</strong>.</p>
</li>
<li><p>Log in to Azure by using the command below. A browser window should open letting you choose which account to log in with.</p>
</li>
</ol>
<pre><code class="lang-azurecli-interactive">az login
</code></pre>
<h2 id="create-resources-in-azure">Create resources in Azure</h2>
<ol>
<li><p>Create a resource group for the resources needed for this exercise.</p>
<pre><code class="lang-azurecli-interactive"> az group create --location eastus --name az204-cosmos-rg
</code></pre>
</li>
<li><p>Create the Azure Cosmos DB account. Replace <code>&lt;myCosmosDBacct&gt;</code> with a unique name to identify your Azure Cosmos DB account. The name can only contain lowercase letters, numbers, and the hyphen (-) character. It must be between 3-31 characters in length. This command will take a few minutes to complete.</p>
<pre><code class="lang-azurecli-interactive"> az cosmosdb create --name &lt;myCosmosDBacct&gt; --resource-group az204-cosmos-rg
</code></pre>
<p> Record the <code>documentEndpoint</code> shown in the JSON response, it will be used below.</p>
</li>
<li><p>Retrieve the primary key for the account by using the command below. Record the primaryMasterKey from the command results it will be used in the code below.</p>
<pre><code class="lang-azurecli-interactive"> # Retrieve the primary key
 az cosmosdb keys list --name &lt;myCosmosDBacct&gt; --resource-group az204-cosmos-rg
</code></pre>
</li>
</ol>
<h3 id="set-up-the-console-application">Set up the console application</h3>
<p>Now that the needed resources are deployed to Azure the next step is to set up the console application using the same terminal window in Visual Studio Code.</p>
<ol>
<li><p>Create a folder for the project and change in to the folder.</p>
<pre><code class="lang-azurecli-interactive"> md az204-cosmos
 cd az204-cosmos
</code></pre>
</li>
<li><p>Create the .NET console app.</p>
<pre><code class="lang-azurecli-interactive"> dotnet new console
</code></pre>
</li>
<li><p>Open the current folder in VS Code using the command below. The -r option will open the folder without launching a new VS Code window.</p>
<pre><code class="lang-azurecli-interactive"> code . -r
</code></pre>
<p> Select the Program.cs file in the <strong>Explorer</strong> pane to open the file in the editor.</p>
</li>
</ol>
<h2 id="build-the-console-app">Build the console app</h2>
<p>It&apos;s time to start adding the packages and code to the project.</p>
<h3 id="add-packages-and-using-statements">Add packages and using statements</h3>
<ol>
<li><p>Open the terminal in VS Code and use the command below to add the <code>Microsoft.Azure.Cosmos</code> package to the project.</p>
<pre><code class="lang-azurecli-interactive"> dotnet add package Microsoft.Azure.Cosmos
</code></pre>
</li>
</ol>
<h3 id="add-code-to-connect-to-an-azure-cosmos-db-account">Add code to connect to an Azure Cosmos DB account</h3>
<ol>
<li><p>Add the code snippet below after the <code>using</code> statement. The code snippet adds constants and variables into the class and adds some error checking. Be sure to replace the placeholder values for EndpointUri and PrimaryKey following the directions in the code comments.</p>
<pre><code class="lang-azurecli-interactive"> dotnet add package Microsoft.Azure.Cosmos
</code></pre>
</li>
<li><p>Delete any existing code in the Program.cs file and add the using Microsoft.Azure statement.</p>
<pre><code class="lang-azurecli-interactive"> using Microsoft.Azure.Cosmos;
</code></pre>
</li>
</ol>
<h3 id="add-code-to-connect-to-an-azure-cosmos-db-account">Add code to connect to an Azure Cosmos DB account</h3>
<ol>
<li><p>Add the code snippet below after the <code>using</code> statement. The code snippet adds constants and variables into the class and adds some error checking. Be sure to replace the placeholder values for <code>EndpointUri</code> and `PrimaryKey following the directions in the code comments.</p>
<pre><code class="lang-azurecli-interactive"> public class Program
 {
     // Replace &lt;documentEndpoint&gt; with the information created earlier
     private static readonly string EndpointUri = &quot;&lt;documentEndpoint&gt;&quot;;

     // Set variable to the Primary Key from earlier.
     private static readonly string PrimaryKey = &quot;&lt;your primary key&gt;&quot;;

     // The Cosmos client instance
     private CosmosClient cosmosClient;

     // The database we will create
     private Database database;

     // The container we will create.
     private Container container;

     // The names of the database and container we will create
     private string databaseId = &quot;az204Database&quot;;
     private string containerId = &quot;az204Container&quot;;

     public static async Task Main(string[] args)
     {
         try
         {
             Console.WriteLine(&quot;Beginning operations...\n&quot;);
             Program p = new Program();
             await p.CosmosAsync();

         }
         catch (CosmosException de)
         {
             Exception baseException = de.GetBaseException();
             Console.WriteLine(&quot;{0} error occurred: {1}&quot;, de.StatusCode, de);
         }
         catch (Exception e)
         {
             Console.WriteLine(&quot;Error: {0}&quot;, e);
         }
         finally
         {
             Console.WriteLine(&quot;End of program, press any key to exit.&quot;);
             Console.ReadKey();
         }
     }
     //The sample code below gets added below this line
 }
</code></pre>
</li>
<li><p>Below the <code>Main</code> method, add a new asynchronous task called <code>CosmosAsync</code>, which instantiates our new <code>CosmosClient</code> and adds code to call the methods you&apos;ll add later to create a database and a container.</p>
<pre><code class="lang-azurecli-interactive"> public async Task CosmosAsync()
 {
     // Create a new instance of the Cosmos Client
     this.cosmosClient = new CosmosClient(EndpointUri, PrimaryKey);

     // Runs the CreateDatabaseAsync method
     await this.CreateDatabaseAsync();

     // Run the CreateContainerAsync method
     await this.CreateContainerAsync();
 }
</code></pre>
</li>
</ol>
<h3 id="create-a-database">Create a database</h3>
<p>Copy and paste the <code>CreateContainerAsync</code> method below the <code>CreateDatabaseAsync</code> method.</p>
<pre><code class="lang-azurecli-interactive">private async Task CreateContainerAsync()
{
    // Create a new container
    this.container = await this.database.CreateContainerIfNotExistsAsync(containerId, &quot;/LastName&quot;);
    Console.WriteLine(&quot;Created Container: {0}\n&quot;, this.container.Id);
}
</code></pre>
<h3 id="run-the-application">Run the application</h3>
<ol>
<li><p>Save your work and, in a terminal in VS Code, run the <code>dotnet run</code> command. The console will display the following messages.</p>
<pre><code class="lang-azurecli-interactive"> Beginning operations...

 Created Database: az204Database

 Created Container: az204Container

 End of program, press any key to exit.
</code></pre>
</li>
<li><p>Verify the results by opening the Azure portal, navigating to your Azure Cosmos DB resource, and use the Data Explorer to view the database and container.</p>
</li>
</ol>
<h3 id="clean-up-azure-resources">Clean up Azure resources</h3>
<p>You can now safely delete the az204-cosmos-rg resource group from your account by running the command below.</p>
<pre><code class="lang-azurecli-interactive">az group delete --name az204-cosmos-rg --no-wait
</code></pre>
<h2 id="create-stored-procedures">Create stored procedures</h2>
<p>Azure Cosmos DB provides language-integrated, transactional execution of JavaScript that lets you write stored procedures, triggers, and user-defined functions (UDFs). To call a stored procedure, trigger, or user-defined function, you need to register it. For more information, see <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/sql/how-to-use-stored-procedures-triggers-udfs" target="_blank">How to work with stored procedures, triggers, user-defined functions in Azure Cosmos DB</a>.</p>
<h3 id="writing-stored-procedures">Writing stored procedures</h3>
<p>Stored procedures can create, update, read, query, and delete items inside an Azure Cosmos container. Stored procedures are registered per collection, and can operate on any document or an attachment present in that collection.</p>
<p>Here&apos;s a simple stored procedure that returns a &quot;Hello World&quot; response.</p>
<pre><code class="lang-azurecli-interactive">var helloWorldStoredProc = {
    id: &quot;helloWorld&quot;,
    serverScript: function () {
        var context = getContext();
        var response = context.getResponse();

        response.setBody(&quot;Hello, World&quot;);
    }
}
</code></pre>
<p>The context object provides access to all operations that can be performed in Azure Cosmos DB, and access to the request and response objects. In this case, you use the response object to set the body of the response to be sent back to the client.</p>
<h3 id="create-an-item-using-stored-procedure">Create an item using stored procedure</h3>
<p>When you create an item by using stored procedure it&apos;s inserted into the Azure Cosmos container and an ID for the newly created item is returned. Creating an item is an asynchronous operation and depends on the JavaScript callback functions. The callback function has two parameters:</p>
<ul>
<li>The error object in case the operation fails</li>
<li>A return value</li>
</ul>
<p>Inside the callback, you can either handle the exception or throw an error. In case a callback isn&apos;t provided and there&apos;s an error, the Azure Cosmos DB runtime will throw an error.</p>
<p>The stored procedure also includes a parameter to set the description, it&apos;s a boolean value. When the parameter is set to true and the description is missing, the stored procedure will throw an exception. Otherwise, the rest of the stored procedure continues to run.</p>
<p>This stored procedure takes as input <code>documentToCreate</code>, the body of a document to be created in the current collection. All such operations are asynchronous and depend on JavaScript function callbacks. The callback function has two parameters, one for the error object in case the operation fails, and one for the created object. Inside the callback, users can either handle the exception or throw an error. In case a callback isn&apos;t provided and there&apos;s an error, the DocumentDB runtime throws an error.</p>
<pre><code class="lang-azurecli-interactive">var createDocumentStoredProc = {
    id: &quot;createMyDocument&quot;,
    body: function createMyDocument(documentToCreate) {
        var context = getContext();
        var collection = context.getCollection();
        var accepted = collection.createDocument(collection.getSelfLink(),
              documentToCreate,
              function (err, documentCreated) {
                  if (err) throw new Error(&apos;Error&apos; + err.message);
                  context.getResponse().setBody(documentCreated.id)
              });
        if (!accepted) return;
    }
}
</code></pre>
<h3 id="arrays-as-input-parameters-for-stored-procedures">Arrays as input parameters for stored procedures</h3>
<p>When defining a stored procedure in the Azure portal, input parameters are always sent as a string to the stored procedure. Even if you pass an array of strings as an input, the array is converted to string and sent to the stored procedure. To work around this, you can define a function within your stored procedure to parse the string as an array. The following code shows how to parse a string input parameter as an array:</p>
<pre><code class="lang-azurecli-interactive">function sample(arr) {
    if (typeof arr === &quot;string&quot;) arr = JSON.parse(arr);

    arr.forEach(function(a) {
        // do something here
        console.log(a);
    });
}
</code></pre>
<h3 id="bounded-execution">Bounded execution</h3>
<p>All Azure Cosmos DB operations must complete within a limited amount of time. Stored procedures have a limited amount of time to run on the server. All collection functions return a Boolean value that represents whether that operation will complete or not</p>
<h3 id="transactions-within-stored-procedures">Transactions within stored procedures</h3>
<p>You can implement transactions on items within a container by using a stored procedure. JavaScript functions can implement a continuation-based model to batch or resume execution. The continuation value can be any value of your choice and your applications can then use this value to resume a transaction from a new starting point. The diagram below depicts how the transaction continuation model can be used to repeat a server-side function until the function finishes its entire processing workload.</p>
<p><img src="images/work_cosmosdb_02.png" alt="alt text"></p>
<h2 id="create-triggers-and-user-defined-functions">Create triggers and user-defined functions</h2>
<p>Azure Cosmos DB supports pre-triggers and post-triggers. Pre-triggers are executed before modifying a database item and post-triggers are executed after modifying a database item. Triggers are not automatically executed, they must be specified for each database operation where you want them to execute. After you define a trigger, you should register it by using the Azure Cosmos DB SDKs.</p>
<h3 id="pre-triggers">Pre-triggers</h3>
<p>The following example shows how a pre-trigger is used to validate the properties of an Azure Cosmos item that is being created, it adds a timestamp property to a newly added item if it doesn&apos;t contain one.</p>
<pre><code class="lang-azurecli-interactive">function validateToDoItemTimestamp() {
    var context = getContext();
    var request = context.getRequest();

    // item to be created in the current operation
    var itemToCreate = request.getBody();

    // validate properties
    if (!(&quot;timestamp&quot; in itemToCreate)) {
        var ts = new Date();
        itemToCreate[&quot;timestamp&quot;] = ts.getTime();
    }

    // update the item that will be created
    request.setBody(itemToCreate);
}
</code></pre>
<p>Pre-triggers cannot have any input parameters. The request object in the trigger is used to manipulate the request message associated with the operation. In the previous example, the pre-trigger is run when creating an Azure Cosmos item, and the request message body contains the item to be created in JSON format.</p>
<p>When triggers are registered, you can specify the operations that it can run with. This trigger should be created with a <code>TriggerOperation</code> value of <code>TriggerOperation.Create</code>, which means using the trigger in a replace operation is not permitted.</p>
<h3 id="post-triggers">Post-triggers</h3>
<p>The following example shows a post-trigger. This trigger queries for the metadata item and updates it with details about the newly created item.</p>
<pre><code class="lang-azurecli-interactive">function updateMetadata() {
var context = getContext();
var container = context.getCollection();
var response = context.getResponse();

// item that was created
var createdItem = response.getBody();

// query for metadata document
var filterQuery = &apos;SELECT * FROM root r WHERE r.id = &quot;_metadata&quot;&apos;;
var accept = container.queryDocuments(container.getSelfLink(), filterQuery,
    updateMetadataCallback);
if(!accept) throw &quot;Unable to update metadata, abort&quot;;

function updateMetadataCallback(err, items, responseOptions) {
    if(err) throw new Error(&quot;Error&quot; + err.message);
        if(items.length != 1) throw &apos;Unable to find metadata document&apos;;

        var metadataItem = items[0];

        // update metadata
        metadataItem.createdItems += 1;
        metadataItem.createdNames += &quot; &quot; + createdItem.id;
        var accept = container.replaceDocument(metadataItem._self,
            metadataItem, function(err, itemReplaced) {
                    if(err) throw &quot;Unable to update metadata, abort&quot;;
            });
        if(!accept) throw &quot;Unable to update metadata, abort&quot;;
        return;
    }
}
</code></pre>
<p>One thing that is important to note is the transactional execution of triggers in Azure Cosmos DB. The post-trigger runs as part of the same transaction for the underlying item itself. An exception during the post-trigger execution will fail the whole transaction. Anything committed will be rolled back and an exception returned.</p>
<h3 id="user-defined-functions">User-defined functions</h3>
<p>The following sample creates a UDF to calculate income tax for various income brackets. This user-defined function would then be used inside a query. For the purposes of this example assume there is a container called &quot;Incomes&quot; with properties as follows:</p>
<pre><code class="lang-azurecli-interactive">{
   &quot;name&quot;: &quot;User One&quot;,
   &quot;country&quot;: &quot;USA&quot;,
   &quot;income&quot;: 70000
}
</code></pre>
<p>The following is a function definition to calculate income tax for various income brackets:</p>
<pre><code class="lang-azurecli-interactive">function tax(income) {

        if(income == undefined)
            throw &apos;no input&apos;;

        if (income &lt; 1000)
            return income * 0.1;
        else if (income &lt; 10000)
            return income * 0.2;
        else
            return income * 0.4;
    }
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="storage_services.html" class="navigation navigation-prev " aria-label="Previous page: 2.3. Azure storage services">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="lab01.html" class="navigation navigation-next " aria-label="Next page: LAB 1 - Create a virtual machine">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"2.4. Azure identity, access, and security","level":"3.1.4","depth":2,"next":{"title":"LAB 1 - Create a virtual machine","level":"4.1","depth":1,"path":"M2/01/lab01.md","ref":"M2/01/lab01.md","articles":[]},"previous":{"title":"2.3. Azure storage services","level":"3.1.3","depth":2,"path":"M2/01/storage_services.md","ref":"M2/01/storage_services.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"M2/01/cloud_security.md","mtime":"2023-01-03T22:50:44.610Z","type":"markdown"},"gitbook":{"version":"4.0.4","time":"2023-01-18T02:41:50.876Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

